# VetKeys IBE 加密安全改进

## 概述

本文档详细说明了对 VetKey 文件加密系统的安全改进，从简单的 AES-GCM 加密升级到完整的身份基加密（IBE）实现。

## 主要安全改进

### 1. 身份基加密（IBE）实现

**改进前**：
- 使用简单的 AES-GCM 对称加密
- 从 vetKey 直接派生 AES 密钥
- 缺少公钥加密的优势

**改进后**：
- 完整实现 IBE 加密方案
- 使用 `IbeCiphertext.encrypt()` 和 `decrypt()` 方法
- 支持基于用户身份的非对称加密

### 2. 传输密钥管理

**改进前**：
- 每次操作都生成新的 `TransportSecretKey`
- 没有清晰的传输密钥作用理解

**改进后**：
- 每次操作生成新的传输密钥（正确的做法）
- 传输密钥仅用于安全传输 VetKey，不影响最终的加密内容
- 基于用户身份的安全性，而非传输密钥
- 可以在任何时候重新生成传输密钥进行解密

### 3. 域分离器

**改进前**：
- 没有域分离，存在跨上下文攻击风险

**改进后**：
- 使用 `DOMAIN_SEPARATOR = "vetkey-file-encryption-v1"`
- 在 IBE 身份中使用域分离器
- 防止密钥在不同上下文中被误用

## 传输密钥的正确理解

### 工作原理：
1. **客户端**：生成传输密钥对（公钥+私钥）
2. **发送**：将传输公钥发送给后端
3. **后端**：使用传输公钥加密 VetKey 并返回
4. **客户端**：使用传输私钥解密得到 VetKey
5. **使用**：VetKey 用于实际的 IBE 加密/解密

### 重要特性：
- **可重新生成**：每次操作都可以生成新的传输密钥
- **不影响内容**：传输密钥不影响最终的加密内容
- **身份驱动**：安全性基于用户身份，而非传输密钥
- **无需持久化**：传输密钥不需要保存或恢复

## 使用场景

✅ **支持的场景**：
- 在不同浏览器中解密同一文件
- 页面刷新后解密文件
- 清除缓存后解密文件
- 使用相同用户 ID 在任何时候解密

❌ **不支持的场景**：
- 使用错误的用户 ID 解密
- 文件被篡改或损坏
- 后端服务不可用

### 4. 混合加密方案

**改进前**：
- 直接使用 vetKey 加密所有数据
- 对大文件效率低下

**改进后**：
- 实现 `encryptLargeData()` 和 `decryptLargeData()`
- 使用 IBE 加密对称密钥
- 使用 AES-GCM 加密实际数据
- 优化大文件处理性能

### 5. 完整性验证

**改进前**：
- 基本的解密尝试验证
- 没有独立的完整性检查

**改进后**：
- 生成 SHA-256 哈希进行完整性验证
- 在元数据中存储哈希值
- 解密前验证文件完整性

### 6. 元数据管理

**改进前**：
- 没有文件元数据
- 文件扩展名简单（.encrypted）

**改进后**：
- 完整的元数据结构：
  ```json
  {
    "originalName": "文件名",
    "originalSize": 文件大小,
    "encryptedSize": 加密后大小,
    "userId": "用户ID",
    "timestamp": "时间戳",
    "hash": "完整性哈希",
    "encryptionVersion": "IBE-v1"
  }
  ```
- 使用 `.vetkey` 扩展名
- 支持版本控制

### 7. 密钥缓存优化

**改进前**：
- 没有密钥缓存
- 重复解密相同的 vetKey

**改进后**：
- 实现智能密钥缓存
- 缓存大小限制（100个密钥）
- 自动清理旧密钥

### 8. 错误处理

**改进前**：
- 简单的 try-catch
- 可能泄露敏感信息

**改进后**：
- 详细的错误分类
- 安全的错误消息
- 不泄露内部实现细节

### 9. 用户界面安全

**改进前**：
- 基本的状态显示
- 没有安全提示

**改进后**：
- 清晰的安全状态指示
- 内置安全建议
- 会话密钥清理选项
- 文件大小限制（100MB）

### 10. 安全测试

新增完整的测试套件：
- 传输密钥管理测试
- 域分离器验证
- 加密完整性测试
- 大文件处理测试
- 密钥缓存限制测试
- 错误处理测试

## 安全最佳实践

1. **传输密钥生成**：每次操作都生成新的传输密钥，确保传输层安全
2. **身份验证**：确保使用正确的用户 ID
3. **文件完整性**：通过 SHA-256 哈希验证文件完整性
4. **认证加密**：IBE 和 AES-GCM 都提供认证加密
5. **安全清除**：对称密钥使用后立即覆盖

## 使用建议

1. 确保用户 ID 的正确性
2. 检查文件完整性验证结果
3. 注意文件大小限制
4. 保持加密文件的 `.vetkey` 扩展名
5. 理解传输密钥的作用和限制

## 合规性

本实现符合以下安全标准：
- ✅ 使用标准的 IBE 算法
- ✅ AES-256-GCM 加密
- ✅ SHA-256 哈希算法
- ✅ 安全的随机数生成
- ✅ 适当的密钥管理

## 未来改进建议

1. 实现密钥轮换机制
2. 添加审计日志功能
3. 支持多用户共享加密
4. 实现密钥托管和恢复
5. 添加更多的加密算法选项 